"""
Конфигурация ставок, коэффициентов и лимитов — 2026 год
Федеральные параметры + региональная специфика Иркутской области

Источники:
- ФЗ от 28.11.2025 № 425-ФЗ (налоговая реформа)
- ФЗ от 28.11.2025 № 429-ФЗ (МРОТ 2026)
- ФЗ от 12.07.2024 № 176-ФЗ (прогрессивная шкала НДФЛ)
- Постановление Правительства от 31.10.2025 № 1705 (ЕПБ)
- Распоряжение Правительства от 30.12.2025 № 4125-р (МСП ОКВЭД)
- Закон ИО от 30.11.2015 № 112-ОЗ (УСН льготы)
- Постановление Главы Адм. ИО от 28.01.1993 № 9 (РК)

Обновлять ежегодно к 1 января!
"""

from dataclasses import dataclass
from decimal import Decimal

# ─────────────────────────────────────────────
# 1. МРОТ
# ─────────────────────────────────────────────
MROT = 27_093  # ФЗ от 28.11.2025 № 429-ФЗ

# ─────────────────────────────────────────────
# 2. НДФЛ — ПРОГРЕССИВНАЯ ШКАЛА (основные доходы)
# ─────────────────────────────────────────────
# (верхняя граница годового дохода, ставка)
NDFL_SCALE = [
    (2_400_000, Decimal("0.13")),
    (5_000_000, Decimal("0.15")),
    (20_000_000, Decimal("0.18")),
    (50_000_000, Decimal("0.20")),
    (None, Decimal("0.22")),  # свыше 50 млн
]

# НДФЛ — шкала для РК и северных надбавок
NDFL_SCALE_NORTH = [
    (5_000_000, Decimal("0.13")),
    (None, Decimal("0.15")),
]

# НДФЛ — дивиденды (резиденты)
NDFL_DIVIDENDS = [
    (2_400_000, Decimal("0.13")),
    (None, Decimal("0.15")),
]

# НДФЛ — нерезиденты
NDFL_NON_RESIDENT = Decimal("0.30")

# НДФЛ — участники СВО
NDFL_SVO = [
    (5_000_000, Decimal("0.13")),
    (None, Decimal("0.15")),
]

# ─────────────────────────────────────────────
# 3. НДФЛ — ВЫЧЕТЫ
# ─────────────────────────────────────────────
@dataclass
class NdflDeductions:
    """Стандартные и социальные вычеты НДФЛ 2026"""
    # Стандартные на детей (в месяц)
    child_1: int = 1_400        # 1-й ребёнок
    child_2: int = 1_400        # 2-й ребёнок (новое: было 1400)
    child_3_plus: int = 3_000   # 3-й и последующие
    child_disabled: int = 12_000  # ребёнок-инвалид (родитель)
    child_disabled_guardian: int = 6_000  # ребёнок-инвалид (опекун)
    child_income_limit: int = 450_000  # предел дохода для вычета

    # Социальные (в год)
    education_self: int = 110_000      # обучение (своё)
    education_child: int = 150_000     # обучение ребёнка
    medical: int = 110_000             # лечение (кроме дорогостоящего)
    sport: int = 110_000               # спорт (включая родителей-пенсионеров с 2026)
    gto: int = 18_000                  # за сдачу ГТО

    # Кэшбэк для многодетных (ФЗ № 179-ФЗ)
    cashback_multichild_rate: Decimal = Decimal("0.07")  # возврат 7% → эфф. ставка 6%

    # Необлагаемые выплаты
    maternity_aid_limit: int = 1_000_000  # матпомощь при рождении (было 50 000)


NDFL_DEDUCTIONS = NdflDeductions()

# ─────────────────────────────────────────────
# 4. СТРАХОВЫЕ ВЗНОСЫ
# ─────────────────────────────────────────────
# Единая предельная база (ЕПБ)
EPB = 2_979_000  # Постановление от 31.10.2025 № 1705

# Базовый тариф
INSURANCE_BASE = Decimal("0.30")       # до ЕПБ
INSURANCE_ABOVE = Decimal("0.151")     # свыше ЕПБ

# МСП — льготный тариф (только приоритетные ОКВЭД с 2026!)
MSP_THRESHOLD_MROT_MULT = Decimal("1.5")  # порог 1,5 × МРОТ
MSP_THRESHOLD = int(MROT * float(MSP_THRESHOLD_MROT_MULT))  # 40 639 ₽
MSP_REDUCED_RATE = Decimal("0.15")     # свыше порога

# IT-компании
IT_RATE_WITHIN = Decimal("0.076")      # до ЕПБ
IT_RATE_ABOVE = Decimal("0.076")       # свыше ЕПБ (без изменений)

# Производственный МСП (обрабатывающие)
MANUFACTURING_MSP_RATE = Decimal("0.076")  # свыше 1,5 МРОТ

# НКО на УСН
NKO_USN_RATE = Decimal("0.076")        # до 2027

# ─────────────────────────────────────────────
# 5. ИП ЗА СЕБЯ
# ─────────────────────────────────────────────
IP_FIXED_CONTRIBUTIONS = 57_390        # фиксированная часть
IP_ADDITIONAL_RATE = Decimal("0.01")   # 1% с дохода > 300 000
IP_ADDITIONAL_INCOME_THRESHOLD = 300_000
IP_ADDITIONAL_MAX = 321_818            # максимум 1%
IP_FIXED_DEADLINE = "2026-12-31"
IP_ADDITIONAL_DEADLINE = "2027-07-01"

# «Воздушные» взносы за директора без зарплаты
DIRECTOR_MIN_CONTRIBUTIONS_MONTHLY = int(MROT * float(INSURANCE_BASE))  # 8 127 ₽
DIRECTOR_MIN_CONTRIBUTIONS_YEARLY = DIRECTOR_MIN_CONTRIBUTIONS_MONTHLY * 12  # 97 534 ₽

# ─────────────────────────────────────────────
# 6. НДС
# ─────────────────────────────────────────────
NDS_BASE_RATE = Decimal("0.22")        # основная (с 2026, было 20%)
NDS_REDUCED_RATE = Decimal("0.10")     # продовольствие, детские, медицина
NDS_ZERO_RATE = Decimal("0.00")        # экспорт, гостиницы до 31.12.2030

# УСН + НДС (пониженные)
NDS_USN_REDUCED_5 = Decimal("0.05")    # до 250 млн дохода
NDS_USN_REDUCED_7 = Decimal("0.07")    # 250–450 млн дохода
NDS_USN_THRESHOLD_2026 = 20_000_000    # порог обязанности НДС на УСН

# Расчётные ставки
NDS_CALCULATED_22 = Decimal(22) / Decimal(122)  # ≈ 18.0328%
NDS_CALCULATED_10 = Decimal(10) / Decimal(110)  # ≈ 9.0909%
NDS_CALCULATED_5 = Decimal(5) / Decimal(105)    # ≈ 4.7619%
NDS_CALCULATED_7 = Decimal(7) / Decimal(107)    # ≈ 6.5421%

# ─────────────────────────────────────────────
# 7. НАЛОГ НА ПРИБЫЛЬ
# ─────────────────────────────────────────────
PROFIT_TAX_TOTAL = Decimal("0.25")     # с 2026 (было 20%)
PROFIT_TAX_FEDERAL = Decimal("0.08")
PROFIT_TAX_REGIONAL = Decimal("0.17")

# ─────────────────────────────────────────────
# 8. УСН
# ─────────────────────────────────────────────
USN_INCOME_RATE = Decimal("0.06")
USN_INCOME_EXPENSE_RATE = Decimal("0.15")
USN_MIN_TAX_RATE = Decimal("0.01")     # минимальный налог (Д-Р)
USN_INCOME_LIMIT = 490_500_000         # предел для УСН
PSN_INCOME_LIMIT_2026 = 20_000_000     # ПСН лимит с 2026

# ─────────────────────────────────────────────
# 9. ТРАВМАТИЗМ (ФСС / СФР)
# ─────────────────────────────────────────────
TRAUMA_RATES = {
    1: Decimal("0.002"),   # I класс профриска
    2: Decimal("0.003"),
    3: Decimal("0.004"),
    4: Decimal("0.005"),
    5: Decimal("0.006"),
    6: Decimal("0.007"),
    7: Decimal("0.008"),
    8: Decimal("0.009"),
    9: Decimal("0.010"),
    10: Decimal("0.011"),
    11: Decimal("0.012"),
    12: Decimal("0.013"),
    13: Decimal("0.014"),
    14: Decimal("0.015"),
    15: Decimal("0.017"),
    16: Decimal("0.019"),
    17: Decimal("0.021"),
    18: Decimal("0.023"),
    19: Decimal("0.025"),
    20: Decimal("0.027"),
    21: Decimal("0.029"),
    22: Decimal("0.031"),
    23: Decimal("0.034"),
    24: Decimal("0.037"),
    25: Decimal("0.040"),
    26: Decimal("0.043"),
    27: Decimal("0.046"),
    28: Decimal("0.050"),
    29: Decimal("0.054"),
    30: Decimal("0.058"),
    31: Decimal("0.062"),
    32: Decimal("0.085"),  # XXXII класс
}
AUSN_TRAUMA_FIXED = 2_959  # АУСН фиксированный тариф

# ═════════════════════════════════════════════
# РЕГИОНАЛЬНЫЕ ПАРАМЕТРЫ — ИРКУТСКАЯ ОБЛАСТЬ
# ═════════════════════════════════════════════

# ─────────────────────────────────────────────
# 10. РАЙОННЫЕ КОЭФФИЦИЕНТЫ
# ─────────────────────────────────────────────
# Группы территорий для быстрого выбора в боте
TERRITORY_GROUPS = {
    "А": {
        "name": "Районы Крайнего Севера",
        "rk": Decimal("1.7"),
        "max_nadbavka": Decimal("0.80"),
        "extra_vacation": 24,
        "women_work_week": 36,
        "territories": ["Катангский район"],
    },
    "Б": {
        "name": "Приравненные к РКС (РК 1.7)",
        "rk": Decimal("1.7"),
        "max_nadbavka": Decimal("0.50"),
        "extra_vacation": 16,
        "women_work_week": 36,
        "territories": [
            "Бодайбинский район", "г. Бодайбо",
            "Мамско-Чуйский район",
            "Киренский район",
            "Казачинско-Ленский район",
            "Усть-Кутский район", "г. Усть-Кут",
        ],
    },
    "В": {
        "name": "Приравненные к РКС (РК 1.6)",
        "rk": Decimal("1.6"),
        "max_nadbavka": Decimal("0.50"),
        "extra_vacation": 16,
        "women_work_week": 36,
        "territories": [
            "г. Усть-Илимск", "Усть-Илимский район",
            "Нижнеилимский район",
        ],
    },
    "Г": {
        "name": "Приравненные к РКС (РК 1.4)",
        "rk": Decimal("1.4"),
        "max_nadbavka": Decimal("0.50"),
        "extra_vacation": 16,
        "women_work_week": 36,
        "territories": ["г. Братск", "Братский район"],
    },
    "Д": {
        "name": "Южные районы Иркутской области",
        "rk": Decimal("1.3"),
        "max_nadbavka": Decimal("0.30"),
        "extra_vacation": 8,
        "women_work_week": 40,
        "territories": [
            "г. Иркутск", "Иркутский район",
            "г. Ангарск", "Ангарский район",
            "г. Шелехов", "Шелеховский район",
            "г. Усолье-Сибирское",
            "г. Черемхово",
            "г. Тулун", "Тулунский район",
            "г. Саянск",
            "г. Зима", "Зиминский район",
            "г. Нижнеудинск", "Нижнеудинский район",
            "г. Тайшет", "Тайшетский район",
            "г. Свирск",
            "Аларский район", "Баяндаевский район",
            "Балаганский район", "Боханский район",
            "Жигаловский район", "Заларинский район",
            "Иркутский район", "Качугский район",
            "Куйтунский район", "Нукутский район",
            "Ольхонский район", "Осинский район",
            "Слюдянский район", "Усольский район",
            "Черемховский район", "Чунский район",
            "Эхирит-Булагатский район",
        ],
    },
}

# Порядок начисления северной надбавки (по стажу)
NADBAVKA_SCHEDULE = {
    "rks": {
        # Катангский район (РКС): 10% через 6 мес, +10% каждые 6 мес до 60%, далее +10%/год
        "initial_months": 6,
        "initial_pct": Decimal("0.10"),
        "increment_months": 6,
        "increment_pct": Decimal("0.10"),
        "threshold_pct": Decimal("0.60"),  # после 60% — рост замедляется
        "slow_increment_months": 12,
        "max_pct": Decimal("0.80"),
    },
    "priravnennye": {
        # Приравненные: 10% через 1 год, +10% за каждый год
        "initial_months": 12,
        "initial_pct": Decimal("0.10"),
        "increment_months": 12,
        "increment_pct": Decimal("0.10"),
        "max_pct": Decimal("0.50"),
    },
    "south": {
        # Южные районы ИО: 10% через 1 год, +10% каждые 2 года
        "initial_months": 12,
        "initial_pct": Decimal("0.10"),
        "increment_months": 24,
        "increment_pct": Decimal("0.10"),
        "max_pct": Decimal("0.30"),
    },
}

# ─────────────────────────────────────────────
# 11. РЕГИОНАЛЬНЫЕ НАЛОГИ — ИРКУТСКАЯ ОБЛАСТЬ
# ─────────────────────────────────────────────

# Транспортный налог (Закон ИО от 04.07.2007 № 53-ОЗ)
TRANSPORT_TAX = {
    # (от, до) л.с. → ставка руб/л.с.
    "car": [
        (0, 100, Decimal("10.5")),
        (101, 150, Decimal("14.5")),
        (151, 200, Decimal("35.0")),
        (201, 250, Decimal("52.5")),
        (251, 9999, Decimal("105.0")),
    ],
    "truck": [
        (0, 100, Decimal("6.5")),
        (101, 150, Decimal("10.0")),
        (151, 200, Decimal("13.0")),
        (201, 250, Decimal("17.0")),
        (251, 9999, Decimal("25.0")),
    ],
    "bus": [
        (0, 200, Decimal("14.0")),
        (201, 9999, Decimal("28.0")),
    ],
    "motorcycle": [
        (0, 20, Decimal("4.0")),
        (21, 35, Decimal("7.0")),
        (36, 9999, Decimal("14.0")),
    ],
}

# Налог на имущество организаций (Закон ИО от 08.10.2007 № 75-ОЗ)
PROPERTY_TAX_ORG = {
    "max_rate": Decimal("0.022"),        # 2,2% — общая
    "cadastral_rate": Decimal("0.020"),  # 2,0% — кадастровая
}

# УСН — региональные льготы (Закон ИО от 30.11.2015 № 112-ОЗ)
USN_REGIONAL = {
    "income_standard": Decimal("0.06"),
    "income_reduced": Decimal("0.01"),           # льготная
    "income_expense_standard": Decimal("0.15"),
    "income_expense_reduced": Decimal("0.05"),   # льготная
    "min_revenue_share": Decimal("0.70"),         # 70% от льготной деятельности
}

# ─────────────────────────────────────────────
# 12. МИНИМАЛЬНАЯ ЗАРПЛАТА ПО ТЕРРИТОРИЯМ ИО
# ─────────────────────────────────────────────
def calc_min_salary(territory_group: str) -> int:
    """Рассчитать минимальную зарплату для группы территорий."""
    group = TERRITORY_GROUPS.get(territory_group)
    if not group:
        raise ValueError(f"Неизвестная группа: {territory_group}")
    rk_extra = group["rk"] - 1  # дополнительная часть РК
    nadbavka = group["max_nadbavka"]
    multiplier = 1 + float(rk_extra) + float(nadbavka)
    return int(MROT * multiplier)


# ─────────────────────────────────────────────
# 13. КЛЮЧЕВЫЕ СРОКИ ОТЧЁТНОСТИ 2026
# ─────────────────────────────────────────────
DEADLINES_2026 = {
    "ndfl_notification_25": "25 число каждого месяца",
    "ndfl_payment_1_22": "28 число текущего месяца",
    "ndfl_payment_23_end": "5 число следующего месяца",
    "ens_payment": "28 число каждого месяца",
    "rsv_quarterly": "25 число после квартала",
    "6ndfl_quarterly": "25 число после квартала",
    "nds_quarterly": "25 число после квартала",
    "profit_quarterly": "25 число после квартала",
    "buh_annual": "2026-03-31",
    "usn_ooo": "2026-03-25",
    "usn_ip": "2026-04-25",
    "ip_fixed": IP_FIXED_DEADLINE,
    "ip_1pct": IP_ADDITIONAL_DEADLINE,
    "transport_org_annual": "2027-03-01",
    "transport_org_q1": "2026-04-28",
    "transport_org_q2": "2026-07-28",
    "transport_org_q3": "2026-10-28",
    "property_org_annual": "2026-03-02",
}
